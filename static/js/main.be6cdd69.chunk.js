(this.webpackJsonpevy=this.webpackJsonpevy||[]).push([[0],{55:function(e,n,t){e.exports=t(65)},65:function(e,n,t){"use strict";t.r(n);var o=t(0),c=t.n(o),a=t(7),r=t.n(a),i=t(21),u=t(13),s=t(45),l=t(96),d=t(97),f=t(26),b=t(11),m=t(22),g=t(46),j=Object(o.createContext)(null),O=function(e){return{id:e.peer,send:function(n){return e.send(n)}}},p=function(e,n,t){var o={id:n.id,send:function(n){e.emit("host/data",c,n),e.emit("any/data",c,n)}},c={id:n.id,send:function(n){e.emit("peer/data",o,n),e.emit("any/data",o,n)}};e.emit("host/data",c,t),e.emit("any/data",c,t)},v=function(e){var n=Object(o.useState)(new g.EventEmitter),c=Object(u.a)(n,1)[0],a=Object(o.useState)({peer:{id:null,ready:!1},host:{id:null,ready:!1},connections:[],isHost:!1,error:null}),r=Object(u.a)(a,2),i=r[0],s=r[1],l=Object(o.useState)(null),d=Object(u.a)(l,2),m=d[0],j=d[1],v=Object(o.useState)(null),h=Object(u.a)(v,2),E=h[0],y=h[1],w=i.connections,k=Object(o.useCallback)((function(e){console.log("dispatch to host",E),null!==E&&E.send(e),i.isHost&&p(c,m,e)}),[E,i.isHost]),C=Object(o.useCallback)((function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;console.log("dispatch to connections",w),w.forEach((function(t){return(null===n||void 0===n?void 0:n.id)!==t.id?t.send(e):void 0})),i.isHost&&p(c,m,e)}),[w,i.isHost]);return Object(o.useEffect)((function(){return Promise.all([t.e(3),t.e(4)]).then(t.t.bind(null,100,7)).then((function(n){var t=n.default,o=new t({host:"peerjs-test-server.herokuapp.com",secure:!0});j(o),console.log("peer created",o);var a=function(e){console.log("creating a host"),c.emit("open"),s((function(n){return Object(b.a)({},n,{isHost:!0,host:Object(b.a)({},n.host,{id:e,ready:!0})})})),o.on("connection",(function(e){console.log("peer connected to host"),s((function(n){return Object(b.a)({},n,{connections:[].concat(Object(f.a)(n.connections),[O(e)])})})),e.on("open",(function(){return c.emit("peer/open",O(e))})),e.on("data",(function(n){console.log("receive data from peer"),c.emit("peer/data",O(e),n),c.emit("any/data",O(e),n)})),e.on("close",(function(){return s((function(n){return Object(b.a)({},n,{connections:n.connections.filter((function(n){return n.id!==O(e).id}))})}))}))}))};o.on("error",(function(e){if(console.log("error happened",e),"unavailable-id"===e.type)return a(i.peer.id);s((function(n){return Object(b.a)({},n,{error:new Error(e.type)})}))})),o.on("open",(function(n){s((function(e){return Object(b.a)({},e,{peer:Object(b.a)({},e.peer,{id:n,ready:!0})})})),null===e?a(n):function(e){console.log("connecting to host");var n=o.connect(e,{serialization:"json"});y(n),n.on("open",(function(){console.log("host is open"),s((function(n){return Object(b.a)({},n,{host:{id:e,ready:!0}})})),c.emit("host/open",O(n))})),n.on("data",(function(e){console.log("receive data from host"),c.emit("host/data",O(n),e),c.emit("any/data",O(n),e)}))}(e)}))})),function(){m&&m.destroy()}}),[]),[i,c,k,C]},h=function(e,n,t,c){!function(e,n,t,c){var a=Object(o.useRef)(t);Object(o.useEffect)((function(){a.current=t}),c),Object(o.useEffect)((function(){console.log(e,t,c);var o=function(){return a.current.apply(a,arguments)};return n.on(e,o),function(){n.removeListener(e,o)}}),[e])}("any/data",e,(function(e,o){Object(m.isActionOf)(n,o)&&t(e,o)}),[n].concat(Object(f.a)(c)))},E={login:Object(m.createAction)("login")(),loginResponse:Object(m.createAction)("login/response")(),newUser:Object(m.createAction)("login/new")(),sendMessage:Object(m.createAction)("message/send")(),receiveMessage:Object(m.createAction)("message/receive")()},y=function(){var e=Object(o.useState)({connecting:!0,currentUser:null,messages:[],users:[]}),n=Object(u.a)(e,2),t=n[0],c=n[1],a=Object(o.useContext)(j),r=Object(u.a)(a,4),i=(r[0],r[1]),s=r[2],l=r[3],d=Object(o.useCallback)((function(e){s(E.login(e))}),[s]),m=Object(o.useCallback)((function(e){s(E.sendMessage(e))}),[s]);return Object(o.useEffect)((function(){i.on("host/open",(function(){return c((function(e){return Object(b.a)({},e,{connecting:!1})}))})),i.on("open",(function(){return c((function(e){return Object(b.a)({},e,{connecting:!1})}))}))}),[]),h(i,E.login,(function(e,n){console.log("on login");var o={userId:e.id,username:n.payload},c=Object(b.a)({},t,{users:[].concat(Object(f.a)(t.users),[o])});e.send(E.loginResponse(Object(b.a)({},c,{currentUser:o}))),l(E.newUser(o),e)}),[t,l]),h(i,E.newUser,(function(e,n){console.log("on new user"),c((function(e){return Object(b.a)({},e,{users:[].concat(Object(f.a)(e.users),[n.payload])})}))}),[t]),h(i,E.loginResponse,(function(e,n){console.log("on login resp"),c(n.payload)}),[]),h(i,E.sendMessage,(function(e,n){console.log("on send msg");var o={author:t.users.find((function(n){return n.userId===e.id})),text:n.payload};l(E.receiveMessage(o))}),[t.users,l]),h(i,E.receiveMessage,(function(e,n){console.log("on receive"),c((function(e){return Object(b.a)({},e,{messages:[].concat(Object(f.a)(e.messages),[n.payload])})}))}),[]),[t,d,m]},w=function(e){Object(s.a)(e);var n=c.a.useState(""),t=Object(u.a)(n,2),a=t[0],r=t[1],i=y(),f=Object(u.a)(i,3),b=f[0],m=f[1],g=f[2],j=Object(o.useCallback)((function(e){m(e),r("")}),[m]),O=Object(o.useCallback)((function(e){g(e),r("")}),[g]);return b.connecting?c.a.createElement(c.a.Fragment,null,"Connecting..."):null===b.currentUser?c.a.createElement(c.a.Fragment,null,c.a.createElement("div",null,"Choose username:"),c.a.createElement(l.a,{value:a,onChange:function(e){return r(e.currentTarget.value)}}),c.a.createElement(d.a,{onClick:function(){return j(a)}},"Send")):c.a.createElement(c.a.Fragment,null,b.messages.map((function(e,n){return c.a.createElement("p",{key:n},"[",e.author.username,"]",e.text)})),c.a.createElement(l.a,{value:a,onChange:function(e){return r(e.currentTarget.value)}}),c.a.createElement(d.a,{onClick:function(){return O(a)}},"Send"))},k=function(e){var n,t=e.route,a=void 0===t?"peer":t,r=e.children,s=Object(i.g)("/".concat(a,"/:id")),l=Object(i.f)(),d=v(null!==(n=null===s||void 0===s?void 0:s.params.id)&&void 0!==n?n:null),f=Object(u.a)(d,3),b=f[0];f[1],f[2];return Object(o.useEffect)((function(){void 0===(null===s||void 0===s?void 0:s.params.id)&&null!==b.host.id&&l.push("/".concat(a,"/").concat(b.host.id))}),[s,b.host.id,l]),c.a.createElement(j.Provider,{value:d},r)};var C=function(){return c.a.createElement(i.c,null,c.a.createElement(i.a,{path:"/t/:id"},c.a.createElement(k,null,c.a.createElement(w,null))),c.a.createElement(i.a,{path:"/"},c.a.createElement(k,null,c.a.createElement(w,null))))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));var S=t(32),M=function(e){var n=e.children;return c.a.createElement(S.a,null,n)};r.a.render(c.a.createElement(c.a.StrictMode,null,c.a.createElement(M,null,c.a.createElement(C,null))),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))}},[[55,1,2]]]);
//# sourceMappingURL=main.be6cdd69.chunk.js.map